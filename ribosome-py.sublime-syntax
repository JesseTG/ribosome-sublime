%YAML 1.2
---
name: Ribosome (Python)
file_extensions: [dna.py, py.dna]
scope: source.dna

contexts:
  main:
    - match: ""
      push: scope:source.python
      with_prototype:
      - match: ^\s*\.+
        comment: Ribosome (possibly with indentation and nested embedded expressions)
        scope: meta.preprocessor.dna
        set: ribosome_line

  ribosome_line:
    - match: \$?$
      comment: End of line
      scope: punctuation.terminator.dna
      pop: true

    - match: "/[+=]"
      comment: Ribosome line operator or command
      scope: keyword.operator.dna punctuation.definition.keyword.dna

    - match: "/!"
      comment: Ribosome command
      scope: keyword.operator.word.dna punctuation.definition.keyword.dna
      set: line_operator

    - match: "[@&][1-9]?(?={)"
      comment: Embedded expression (possibly nested and/or whitespace-stripping)
      scope: keyword.operator.dna punctuation.definition.keyword.dna
      push: at_expression

    - match: .
      scope: string

  line_operator:
    - match: "(?<=/!)(output|stdout|append|separate|tabsize|include)"
      comment: One of the built-in Ribosome commands
      scope: keyword.operator.word.dna

    - match: \(
      comment: Begin command argument
      push: scope:source.python
      with_prototype:
        - match: (?=\))
          comment: End command argument
          pop: true

    - match: \)
      pop: true


  at_expression:
    - match: \{
      comment: Beginning of the @expression
      push: scope:source.python
      with_prototype:
        - match: "(at|amp|slash)"
          comment: Some special escape sequences
          scope: constant.character.escape.dna
        - match: (?=\})
          comment: End expression
          pop: true

    - match: \}
      pop: true
